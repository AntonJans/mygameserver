#!/usr/bin/env python3

import argparse
import datetime
import logging

import psycopg2

from ctf_gameserver.lib.args import get_arg_parser_with_db


def update_database(db):
    with db:
        with db.cursor() as cursor:
            cursor.execute("UPDATE scoring_gamecontrol SET current_tick = current_tick + 1")
            cursor.execute("""INSERT INTO scoring_flag
                                 (service_id, protecting_team_id, tick)
                              SELECT svc.id, user_id, current_tick
                              FROM scoring_service svc, registration_team, scoring_gamecontrol""")


def main():
    logging.basicConfig()

    parser = get_arg_parser_with_db('CTF Gameserver Controller')
    args = parser.parse_args()

    numeric_level = getattr(logging, args.loglevel.upper())
    logging.getLogger().setLevel(numeric_level)

    db = psycopg2.connect(host=args.dbhost,
                          database=args.dbname,
                          user=args.dbuser,
                          password=args.dbpassword)

    with db:
        with db.cursor() as cursor:
            cursor.execute('SELECT start, "end" FROM scoring_gamecontrol')
            start, end = cursor.fetchone()

    now = datetime.datetime.now(tz=datetime.timezone.utc)
    if start is None or now < start:
        logging.info("Contest not running yet")
        return
    elif now > end:
        logging.info("contest already over")
        return
    else:
        update_database(db)


if __name__ == '__main__':
    main()
